From 75b758917c377c0a9a92b9725d80b81b12450ac1 Mon Sep 17 00:00:00 2001
From: Zubin Mithra <zsm@google.com>
Date: Thu, 18 May 2023 10:15:24 -0700
Subject: [PATCH] cros-syzkaller: retry upon repair failure

---
 vm/isolated/isolated.go | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/vm/isolated/isolated.go b/vm/isolated/isolated.go
index 922dea482..b7498f2a1 100755
--- a/vm/isolated/isolated.go
+++ b/vm/isolated/isolated.go
@@ -115,8 +115,17 @@ func (pool *Pool) Create(workdir string, index int) (vmimpl.Instance, error) {
 			closeInst.Close()
 		}
 	}()
+
+	repairFailThreshold := 20
+	failed := 0
+retryRepair:
 	if err := inst.repair(); err != nil {
-		return nil, fmt.Errorf("repair failed: %v", err)
+		if failed >= repairFailThreshold {
+			return nil, fmt.Errorf("repair failed: %v", err)
+		}
+		failed++
+		log.Logf(0, "repair failed: retry (%v)", failed)
+		goto retryRepair
 	}
 
 	// Remount to writable.
-- 
2.40.1.698.g37aff9b760-goog

